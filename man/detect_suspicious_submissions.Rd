% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/SuspiciousSubmissions.R
\name{detect_suspicious_submissions}
\alias{detect_suspicious_submissions}
\title{Flag suspicious submissions and enforce pre/post comparability checks}
\usage{
detect_suspicious_submissions(
  x,
  id_col = 1,
  time_col = NULL,
  cutoff_time,
  include_cols = NULL,
  group_action = c("split_only", "omit_pre", "omit_post", "none"),
  comparability_rule = c("fdr_effect"),
  alpha = 0.05,
  fdr_method = "BH",
  min_effect_numeric = 0.2,
  min_effect_categorical = 0.1,
  min_flagged_field_share = 0.2,
  min_complete_rate = 0.6,
  risk_weights = NULL,
  risk_threshold = 0.7,
  action = c("flag_only", "exclude_high_risk", "exclude_confirmed_duplicates"),
  return_flat = FALSE,
  quiet = FALSE
)
}
\arguments{
\item{x}{A data frame of responses, or a list from \code{\link[=flatten_submission_records]{flatten_submission_records()}}.}

\item{id_col}{Integer or character. Submission ID column (default 1).}

\item{time_col}{Optional timestamp column name. If \code{NULL}, common timestamp
names are guessed.}

\item{cutoff_time}{Required cutoff separating pre and post groups.}

\item{include_cols}{Optional columns to include in comparability tests. If
\code{NULL}, all analyzable non-ID, non-time columns are considered.}

\item{group_action}{One of \code{"split_only"} (default), \code{"omit_pre"},
\code{"omit_post"}, or \code{"none"}.}

\item{comparability_rule}{Currently only \code{"fdr_effect"}.}

\item{alpha}{Significance threshold for adjusted p-values.}

\item{fdr_method}{P-adjust method passed to \code{\link[stats:p.adjust]{stats::p.adjust()}}.}

\item{min_effect_numeric}{Minimum absolute numeric effect size (SMD).}

\item{min_effect_categorical}{Minimum categorical effect size (Cramer's V).}

\item{min_flagged_field_share}{Minimum share of tested fields marked
different to classify groups as non-comparable.}

\item{min_complete_rate}{Minimum non-missing rate required for a field to be
tested.}

\item{risk_weights}{Named list or vector of row-level risk weights.}

\item{risk_threshold}{Threshold for high-risk labeling.}

\item{action}{One of \code{"flag_only"}, \code{"exclude_high_risk"},
\code{"exclude_confirmed_duplicates"}.}

\item{return_flat}{Logical. If \code{TRUE} and \code{x} came from \code{\link[=flatten_submission_records]{flatten_submission_records()}},
include updated list as \code{flat}.}

\item{quiet}{Logical. If \code{FALSE}, prints a short summary.}
}
\value{
A list with:
\describe{
\item{data}{Primary analysis dataset after group action + row action}
\item{datasets}{List with \code{pre}, \code{post}, and \code{full} datasets}
\item{comparability}{List with global comparability metrics and \code{field_tests}}
\item{decision_sentence}{One-sentence human-readable decision summary}
\item{flags}{Row-level suspiciousness flags and risk scores}
\item{summary}{High-level counts and selected actions}
\item{diagnostics}{Supplementary diagnostic tables}
\item{flat}{If \code{return_flat = TRUE} and input is a flat list, updated list}
}
}
\description{
Evaluates whether pre/post time groups are statistically comparable and
produces row-level suspiciousness flags. This is designed for workflows where
a survey changed mid-collection (for example, from anonymous to identity
verified) and pooled analysis may no longer be valid.
}
\details{
For each analyzable field, the function compares pre (\code{time < cutoff_time})
and post (\code{time >= cutoff_time}) groups using:
\itemize{
\item Numeric fields: Wilcoxon rank-sum + standardized mean difference (SMD)
\item Categorical fields: Chi-square (or Fisher fallback) + Cramer's V
}

A field is marked different when both adjusted p-value and effect-size
thresholds are met. If enough fields differ, pooled analysis is flagged as
non-comparable.
}
\section{When pre/post groups must not be pooled}{

If \code{comparability$non_comparable} is \code{TRUE}, pooled pre+post inference should
be treated as invalid by default. Prefer either:
\itemize{
\item \code{group_action = "omit_pre"} (usually preferred when post is identity-verified),
\item \code{group_action = "omit_post"}, or
\item \code{group_action = "split_only"} and analyze groups separately.
}
}

\examples{
\dontrun{
data("SuspiciousSurveyDemo", package = "FormIOr")

out <- detect_suspicious_submissions(
  SuspiciousSurveyDemo,
  id_col = "submissionId",
  time_col = "created",
  cutoff_time = "2026-01-06 00:00:00",
  group_action = "split_only"
)

out$comparability$non_comparable
head(out$comparability$field_tests)

# If groups differ and post phase is identity-verified, prefer post-only:
post_only <- detect_suspicious_submissions(
  SuspiciousSurveyDemo,
  id_col = "submissionId",
  time_col = "created",
  cutoff_time = "2026-01-06 00:00:00",
  group_action = "omit_pre"
)
}

}
